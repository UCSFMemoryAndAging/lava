<?xml version="1.0"?>
    
<!DOCTYPE hibernate-mapping PUBLIC 
    "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
    "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd"
    [<!ENTITY patientProtocolInclude SYSTEM "classpath://../hibernate/crms/protocol/patientProtocolInclude.xml" >
     <!ENTITY patientProtocolFilterInclude SYSTEM "classpath://../hibernate/crms/protocol/patientProtocolFilterInclude.xml" >]>
    
<hibernate-mapping>

	<class name="edu.ucsf.lava.crms.protocol.model.PatientProtocolTracking" table="ptprot_node" select-before-update="true">

		&patientProtocolInclude;
		
		<many-to-one name="parent" class="edu.ucsf.lava.crms.protocol.model.PatientProtocolTracking" column="parent_id" cascade="none"/>
		<many-to-one name="protocolCounterpart" column="prot_node_id" class="edu.ucsf.lava.crms.protocol.model.ProtocolTracking"/>	
	
		<!-- bilateral. the parent is mapped above. -->
		<set name="children" table="ptprot_node" inverse="true" cascade="all,delete-orphan" order-by="list_order">
			<key column="parent_id"/>
			<one-to-many class="edu.ucsf.lava.crms.protocol.model.PatientProtocolTracking"/> 
		</set>
		 
		&patientProtocolFilterInclude;
		
	</class>		
	
	<query name="patientProtocol.protocolTree"><![CDATA[
		from edu.ucsf.lava.crms.protocol.model.PatientProtocolTracking protocol
		left join fetch protocol.protocolCounterpart
		left join fetch protocol.children timepoint
		left join fetch timepoint.protocolCounterpart
		left join fetch timepoint.children visit
		left join fetch visit.protocolCounterpart
		left join fetch visit.children instrument
		left join fetch instrument.protocolCounterpart
		where protocol.id = :protocolId
	]]></query>	
	
	<query name="patientProtocol.timepointTree"><![CDATA[
		from edu.ucsf.lava.crms.protocol.model.PatientProtocolTracking timepoint
		left join fetch timepoint.protocolCounterpart
		left join fetch timepoint.children visit
		left join fetch visit.protocolCounterpart
		left join fetch visit.children instrument
		left join fetch instrument.protocolCounterpart
		where timepoint.id = :timepointId
	]]></query>	

	<query name="patientProtocol.visitTree"><![CDATA[
		from edu.ucsf.lava.crms.protocol.model.PatientProtocolTracking visit
		left join fetch visit.protocolCounterpart
		left join fetch visit.children instrument
		left join fetch instrument.protocolCounterpart
		where visit.id = :visitId
	]]></query>	

</hibernate-mapping>



